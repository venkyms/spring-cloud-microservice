# spring-cloud-microservice
- git-local-config-repo
    - stores/holds all configurations/properties for different environment 
    - create the configuration in this module and make it as local git repo and commit all the changes. or the config-repo will not load the change in properties
- spring-cloud-config-repo
    - server port - 8888
    - loads all configuration/properties from git-local-config-repo
- limits-service (exposed service)
    - on default port 8080
    - service which will connect to spring-cloud-config-repo to fetch properties for corresponding environment.
    - spring-cloud-config-repo internally connects to git-local-config-repo to load property
    - remove default values set in application.properties
    - rename application.properties to different name so there is no default value loaded from this application.properties, instead values are loaded by config-server
        - configure spring.cloud.config.uri in properties file
        - spring.application.name should match the properties file name in git-local-config-repo
    - http://localhost:8080/limits/ will show the default values from limits-service.properties
    - configure profiles (dev/sandbox/int/stage/prod)
        - for example change the properties in your service module spring.profiles.active=dev
        - can be parameterized using vm arg 
- Currency-exchange-service
    - Contains exchange values
    - server port - 8000
    - Use Environment Interface from spring evn package to access environment properties
        - for example environment.getProperty("local.server.port")
    - dynamic vm args can be passed for server.port
        - for example vm args while starting the application "-Dserver.port=8000"
    - JPA
        - include spring-starter-data, and h2db
        - convert ExchangeValue to entity
        - create data.sql file in resource and feed the default values in the h2db
        - spring.jpa.show-sql=true  
        - spring.h2.console.enabled=true 
        - access h2-console via http://localhost:8000/h2-console
        - create a repository class to send the correct response by extending JpaRepository Interface
        - Spring data jpa has lot of implementation built-in for example findby**
- Currency-conversion-service
    - Integrates currency-exchange-service using RestTemplate (refer CurrencyConversionController)
    - server port - 8100
    - Fiegn(rest service client) to invoke rest service, provides ribbon client side load balancing (Netflix OpenSource)
        - spring-cloud-starter-openfeign artifact in pom
        - enable feign in application class with annotation @EnableFeignClients("com.venkyms.microservices.currencyconversionservice")
        - create fiegn proxy to integrate external service CurrencyExchangeServiceProxy
    - Ribbon - loadbalancing
        - spring-cloud-starter-netflix-ribbon artifact in pom
        - Enable ribbon on proxy class
        - @RibbonClient(name = "currency-exchange-service") , once ribbon client is enabled url is not required in Feign. instead define ribbon.listOfServers for load balancing
        - In this case we hardcode the list of exchange-service in application.properties for ribbon, to avoid this naming servers should be used
    - Eureka - Naming server
        - Used for service registration and service discovery
        - Every time a microservice boots up it will register with naming server
        - While client is consuming the service they discover the service using naming server
        - include artifact spring-cloud-starter-netflix-eureka-server in pom
        - Enable Eureka server with annotation in application class @EnableEurekaServer
        - http://localhost:8761/ 
    - Integrate Eureka Naming server in currency-conversion-service
        - spring-cloud-starter-netflix-eureka-client artifact in the pom
        - in application class @EnableDiscoveryClient to enable name registration
        - add to application.properties 
            - eureka.client.service-url.default-zone=http://localhost:8761/eureka
        - start the server and look for registered service in eureka page
    - Integrate Eureka Naming server in Currency-exchange-service, limits-service
        - steps are similar to above one
    - Next step remove the hard coding of ribbon server list from properties file and try using naming server
        - remove the hard coding of server and eureka.client.service-url.default-zone should take care of load balancing
    - finally when we access currency-conversion-service , ribbon should take care of the load balancing the request to currency-exchange service
    - And whenever microservice boots up, it gets registered with eureka naming service
        
- API Gateway (Netflix Zuul API gateway)
    - provides
        - Authentication and authorization
        - Rate limits
        - Fault Tolerant
        - Service Aggregation
    - Netflix Zuul API gateway
    - Setup Zuul API gateway
        - create new component
    - zuul-api-gateway-server
        - @EnableZuulProxy in application class
        - @EnableDiscoveryClient - this is for eureka naming server
        - update application.properties with application name, port and eureka default-zone
        - server.port=8765
        - Implement logfilter to log the request extends ZuulFilter - Refer class ZuulLogginFilter.java
        - Intercept the request in Zuul gateway - route all the required service request via the API gateway
            - need to configure http://localhost:8765/{application-name}/{uri}
                - application-name as defined in each service application.properties
                - uri is the path variables 
                - for example http://localhost:8765/currency-exchange-service/currency-exchange/from/USD/to/INR/
                - with above url the request specific to exchange-service can be routed via zuul
            - setting zuul API gateway for all microservice invocation
                - As of now Currency-conversion-service talks to Currency-exchange-service using FeignClient
                - Now change the FeignClient parameter to point to Zuul API Gateway in the proxy class
                - and prepend the @GetMapping with application-name to match with ZUUL API request
                - with this Currency-conversion interaction with currency-exchange is via api gateway
            - set up zuul api for currency-conversion-service
                - need to follow pattern http://localhost:8765/{application-name}/{uri}
                - for example http://localhost:8765/currency-conversion-service/currency-converter-feign/from/USD/to/INR/quantity/1000
                - so by invoking parent service with zuul api gateway should invoke internal service
        
- Distributed Tracing (spring cloud sleuth + Zipkin)
    - spring cloud sleuth
        - assign unique id to each request like the conversationID, traceable
    - Zipkin
        - distributed tracing system
        - Logs from each component is pushed to mq and sent to zipkin server
        - Consolidated view for the log
    - Integrate Sleuth to conversion-service, exchange-service and gateway
        - artifact spring-cloud-starter-sleuth
        - added sampler bean to application class in the service required
        - in log you should see a unique id which can be used to trace the log throughout the lifecycle of the request
        - All this logs can be pushed to the central zipkin server to consolidate the logs
    - Zipkin server
        - RabbitMQ to push data to zipkin server
        - install rabbitMQ in your, needs erlang follow https://www.rabbitmq.com/download.html
            - this should start by default as windows server, if not start menu has all start/restart/stop options
        - download executable version of zipkin and run zipkin locally, you could use container version as well
            - https://zipkin.io/pages/quickstart
            - start using java -jar <jar file>
            - access zipkin via http://localhost:9411/zipkin/
            - start zipkin with rabbitmq param 
                - Windows
                    - SET RABBIT_URI=amqp://localhost
                      java -jar <jar file>
                - linux
                    - RABBIT_URI=amqp://localhost java -jar <jar file>   
             - to integrate zipkin/rabbitmq in all required module
                - artifact spring-cloud-starter-zipkin, spring-rabbit
                - this should autoconfigure
    